<div class="manage-wrapper">
  @if (service(); as s) {
    <header class="management-header">
      <div class="header-left">
        <button class="icon-btn" (click)="goBack()" title="Back">
          <mat-icon>arrow_back</mat-icon>
        </button>
      </div>

      <div class="header-middle">
        <div class="pill-toggle">
          <button [class.active]="viewMode() === 'details'" (click)="setViewMode('details')">
            Details
          </button>
          <button [class.active]="viewMode() === 'calendar'" (click)="setViewMode('calendar')">
            Calendar
          </button>
        </div>
      </div>

      <div class="header-right">
        <button class="action-icon-btn" (click)="viewPublic()" title="View Public Page">
          <mat-icon>visibility</mat-icon>
        </button>
        <button class="action-icon-btn" (click)="openEditModal()" title="Edit Settings">
          <mat-icon>edit</mat-icon>
        </button>
        <button class="action-icon-btn delete" (click)="deleteService()" title="Delete Service">
          <mat-icon>delete_outline</mat-icon>
        </button>
      </div>
    </header>

    <main class="content-container fade-in">
      
      @if (viewMode() === 'details') {
        <div class="details-layout">
          
          <section class="gallery-preview-container">
            <div class="section-header-inline">
              <h3>Work Gallery</h3>
              <button class="add-photo-mini" (click)="openEditModal()" title="Add Photos">
                <mat-icon>add</mat-icon>
              </button>
            </div>

            @if (s.portfolio && s.portfolio.length > 0) {
              <div class="mosaic-grid">
                <div class="mosaic-main" (click)="openEditModal()">
                  <img [src]="s.portfolio[0].url.replace('/upload/', '/upload/w_800,c_fill/')" alt="Hero">
                </div>
                
                <div class="mosaic-side">
                  @for (img of s.portfolio.slice(1, 3); track img.public_id) {
                    <div class="side-item" (click)="openEditModal()">
                      <img [src]="img.url.replace('/upload/', '/upload/w_400,h_400,c_fill/')" alt="Work">
                    </div>
                  }
                  
                  @if (s.portfolio.length > 3) {
                    <div class="side-item more-overlay" (click)="openEditModal()">
                      <span>+{{ s.portfolio.length - 3 }}</span>
                    </div>
                  }
                </div>
              </div>
            } @else {
              <div class="empty-gallery-drop" (click)="openEditModal()">
                <mat-icon>add_a_photo</mat-icon>
                <p>Click to upload your work gallery</p>
              </div>
            }
          </section>

          <section class="service-core-info">
            <div class="main-title-row">
              <h1 class="business-name">{{ s.businessName }}</h1>
              <div class="status-pill" [class.active]="true">Active</div>
            </div>

            <div class="quick-info-bar">
              <div class="info-item">
                <mat-icon>category</mat-icon>
                <div class="details">
                  <label>Category</label>
                  <span>{{ s.category }}</span>
                </div>
              </div>

              <div class="info-item">
                <mat-icon>payments</mat-icon>
                <div class="details">
                  <label>Hourly Rate</label>
                  <span>{{ s.hourlyRate | currency }}/hr</span>
                </div>
              </div>

              @if(s.businessAddress){
                <div class="info-item">
                  <mat-icon>location_on</mat-icon>
                  <div class="details">
                    <label>Service Area</label>
                    <span>{{ s.businessAddress }}</span>
                  </div>
                </div>
              }
            </div>

            

            <div class="dynamic-sections-container">
              @if (s.customSections) {
                @if (s.customSections.links?.length) {
                  <div class="description-block">
                    <h3>Social Links</h3>
                    <div class="social-links-strip">
                      @for (link of s.customSections.links; track link.url) {
                        <a [href]="link.url" target="_blank" class="social-icon-btn" [title]="link.platform">
                          <mat-icon>{{ getSocialIcon(link.platform) }}</mat-icon>
                        </a>
                      }
                    </div>
                  </div>
                }
                
                @if (s.customSections.general) {
                  <div class="description-block">
                    <h3>About the Service</h3>
                    <p class="formatted-text">{{ s.customSections.general.content || 'No description provided.' }}</p>
                  </div>
                }

                @if (s.customSections.faq?.content) {
                  <div class="description-block">
                    <div class="section-header">
                      <h3>FAQ</h3>
                      <mat-icon class="visibility-hint" 
                                [title]="s.customSections.faq?.isPublic ? 'Visible to public' : 'Private'">
                        {{ s.customSections.faq?.isPublic ? 'visibility' : 'visibility_off' }}
                      </mat-icon>
                    </div>
                    <p class="formatted-text">{{ s.customSections.faq?.content }}</p>
                  </div>
                }

                @if (s.customSections.payment?.content) {
                  <div class="description-block private-note">
                    <div class="section-header">
                      <h3>Payment Details</h3>
                      <mat-icon class="visibility-hint" 
                                [title]="s.customSections.payment?.isPublic ? 'Visible to public' : 'Private'">
                        {{ s.customSections.payment?.isPublic ? 'visibility' : 'visibility_off' }}
                      </mat-icon>
                      <span class="private-badge">Sensitive Info</span>
                    </div>
                    <p class="formatted-text">{{ s.customSections.payment?.content }}</p>
                  </div>
                }

                @if (s.customSections.additional) {
                  @for (section of s.customSections.additional; track $index) {
                    <div class="description-block">
                      <div class="section-header">
                        <h3>{{ section.title }}</h3>
                        <mat-icon class="visibility-hint" 
                                  [title]="section.isPublic ? 'Visible to public' : 'Private'">
                          {{ section.isPublic ? 'visibility' : 'visibility_off' }}
                        </mat-icon>
                      </div>  
                      <p class="formatted-text">{{ section.content }}</p>
                    </div>
                  }
                }
              } @else {
                <div class="description-block">
                  <h3>About the Service</h3>
                  <p class="formatted-text">Service details are being updated...</p>
                </div>
              }
            </div>
          </section>
        </div>
      }

      @if (viewMode() === 'calendar') {
        <div class="calendar-layout">
          <div class="calendar-instructions">
            <h3>Manage Availability & Pricing</h3>
            <p>Your calendar shows bookings from all services to prevent double-booking.</p>
          </div>
          <provider-calendar 
            [serviceId]="s.id!" 
            [providerId]="s.userId!" 
            [basePrice]="s.hourlyRate!">
          </provider-calendar>
        </div>
      }
    </main>
  }
</div>
