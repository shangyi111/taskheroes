@if (service$ | async; as service) {
<div class="service-details-container">
  <button mat-button class="back-to-search-link" (click)="goBackToSearch()">
    <mat-icon>arrow_back</mat-icon>
    Back to Search Results
  </button>

  <mat-card class="combined-booking-card">
    <div class="card-content-wrapper">
      
      <div class="service-info-column">
        <div class="header-section">
          <img class="business-avatar" [src]="service.profilePicture?.url" alt="Profile">
          <div class="header-text">
            <h1 class="business-name">{{ service.businessName }}</h1>
            <div class="badge-row">
              <span class="category-tag">{{ service.category }}</span>
              @if (averageRating$ | async; as avg) {
                <div class="mini-rating">
                  <mat-icon>star</mat-icon>
                  <strong>{{ avg | number:'1.1-1' }}</strong>
                  <span class="total-count">({{ reviewCount$ | async }})</span>
                </div>
              }
            </div>
          </div>
        </div>

        <div class="content-block">
          <h3>About the Service</h3>
          <p class="description">{{ service.description }}</p>
        </div>

        @if (service.portfolio && service.portfolio.length > 0) {
        <div class="content-block">
          <h3>Work Gallery</h3>
          <div class="portfolio-carousel">
            <div class="main-image-container">
              <img [src]="activeImageUrl" class="main-slide" alt="Portfolio work">
              
              @if (service.portfolio.length > 1) {
                <button class="nav-btn prev" (click)="prevSlide(service.portfolio)">
                  <mat-icon>chevron_left</mat-icon>
                </button>
                <button class="nav-btn next" (click)="nextSlide(service.portfolio)">
                  <mat-icon>chevron_right</mat-icon>
                </button>
              }
            </div>

            <div class="thumbnail-row">
              @for (img of service.portfolio; track img.public_id; let i = $index) {
                <div class="thumb-item" 
                      [class.active]="activeImageUrl === img.url!"
                      (click)="setActiveImage(img.url!, i)">
                  <img [src]="img.url.replace('/upload/', '/upload/w_100,h_100,c_fill,q_auto/')">
                </div>
              }
            </div>
          </div>
        </div>
        }

        <div class="content-block price-highlight">
          <div class="price-pill">
            <mat-icon>payments</mat-icon>
            <div class="price-details">
              <span class="label">Base Hourly Rate</span>
              <span class="amount">{{ service.hourlyRate | currency }}</span>
            </div>
          </div>
        </div>

        <div class="content-block contact-section">
          <div class="contact-row">
            <mat-icon>place</mat-icon>
            <span>{{ service.businessAddress }}</span>
          </div>
          <div class="contact-row">
            <mat-icon>call</mat-icon>
            <span>{{ service.phoneNumber }}</span>
          </div>
        </div>
      </div>

      <div class="calendar-booking-column">
        <div class="booking-header">
          <h2>Select Availability & Book</h2>
          <p>Choose a date to see available time slots</p>
        </div>
        <div class="calendar-card">
          <seeker-calendar
            [service]="service"
            [user]="user!"
            (bookRequest)="handleBookingSubmission($event)">
          </seeker-calendar>
        </div>
      </div>

    </div>
  </mat-card>

  <app-service-reviews [serviceId]="service.id"></app-service-reviews>
</div>
}

@if (showAuthOptions()) {
  <div class="modal-overlay">
    <div class="choice-card">
      <button class="close-btn" (click)="showAuthOptions.set(false)">
        <mat-icon>close</mat-icon>
      </button>

      <h2>Complete Your Request</h2>
      <p>Sign in to message the provider directly and track your booking in real-time.</p>

      <div class="actions">
       <div id="google-btn-container"></div>

        <button mat-stroked-button (click)="redirectToRegister()">
          Create Account / Sign In
        </button>

        <div class="divider">
          <span>OR</span>
        </div>

        <div class="guest-section">
          <p class="guest-label">Continue as guest (email only)</p>
          <div class="guest-input-group">
            <input type="email" #guestEmail placeholder="Enter your email" />
            <button mat-flat-button color="accent" 
                    [disabled]="isSubmitting()"
                    (click)="submitAsGuest(guestEmail.value)">
              {{ isSubmitting() ? 'Sending...' : 'Send Request' }}
            </button>
          </div>
          <small>Note: You won't be able to use the live chat as a guest.</small>
        </div>
      </div>
    </div>
  </div>
}