@if (service$ | async; as s) {
<div class="service-details-wrapper">
  
  <header class="seeker-header">
    <div class="header-left">
      <button class="icon-btn" (click)="goBackToSearch()" title="Back">
        <mat-icon>arrow_back</mat-icon>
      </button>
    </div>

    <div class="header-middle">
      <div class="pill-toggle">
        <button [class.active]="viewMode() === 'details'" (click)="setViewMode('details')">Details</button>
        <button [class.active]="viewMode() === 'calendar'" (click)="setViewMode('calendar')">Book</button>
      </div>
    </div>

    <div class="header-right">
      <button class="action-icon-btn"><mat-icon>share</mat-icon></button>
    </div>
  </header>

  <main class="content-container fade-in">
    @if (viewMode() === 'details') {
      <div class="details-layout">
        
        <section class="gallery-preview-container">
          @if (s.portfolio && s.portfolio.length > 0) {
            <div class="mosaic-grid">
              <div class="mosaic-main">
                <img [src]="s.portfolio[0].url.replace('/upload/', '/upload/w_800,c_fill/')" alt="Featured">
              </div>
              <div class="mosaic-side">
                @for (img of s.portfolio.slice(1, 3); track img.public_id) {
                  <div class="side-item">
                    <img [src]="img.url.replace('/upload/', '/upload/w_400,h_400,c_fill/')" alt="Gallery">
                  </div>
                }
                @if (s.portfolio.length > 3) {
                  <div class="side-item more-overlay">
                    <span>+{{ s.portfolio.length - 3 }}</span>
                  </div>
                }
              </div>
            </div>
          }
        </section>

        <section class="service-core-info">
          <div class="main-title-row">
            <h1 class="business-name">{{ s.businessName }}</h1>
            @if (averageRating$ | async; as avg) {
              <div class="rating-pill">
                <mat-icon>star</mat-icon>
                <span>{{ avg | number:'1.1-1' }} ({{ reviewCount$ | async }})</span>
              </div>
            }
          </div>

          <div class="quick-info-bar">
            <div class="info-item">
              <mat-icon>category</mat-icon>
              <div class="details">
                <label>Category</label>
                <span>{{ s.category }}</span>
              </div>
            </div>
            <div class="info-item">
              <mat-icon>payments</mat-icon>
              <div class="details">
                <label>Hourly Rate</label>
                <span>{{ s.hourlyRate | currency }}/hr</span>
              </div>
            </div>
            @if(s.businessAddress){
              <div class="info-item">
                <mat-icon>location_on</mat-icon>
                <div class="details">
                  <label>Service Area</label>
                  <span>{{ s.businessAddress }}</span>
                </div>
              </div>
            }
          </div>

          <div class="dynamic-sections-container">
            @if (s.customSections?.links?.length) {
              <div class="description-block">
                <h3>Social & Marketplace Links</h3>
                <div class="social-links-strip">
                  @for (link of s.customSections?.links; track link.url) {
                    <a [href]="link.url" target="_blank" class="social-icon-btn" [title]="link.platform">
                      <mat-icon>{{ getSocialIcon(link.platform) }}</mat-icon>
                    </a>
                  }
                </div>
              </div>
            }
            @if (s.customSections?.general?.content) {
              <div class="description-block">
                <h3>About</h3>
                <p class="formatted-text">{{ s.customSections?.general?.content }}</p>
              </div>
            }

            @if (s.customSections?.faq?.isPublic && s.customSections?.faq?.content) {
              <div class="description-block">
                <h3>FAQ</h3>
                <p class="formatted-text">{{ s.customSections?.faq?.content }}</p>
              </div>
            }
            @if (s.customSections?.payment?.isPublic && s.customSections?.payment?.content) {
              <div class="description-block public-payment-note">
                <h3>Payment Methods</h3>
                <p class="formatted-text">{{ s.customSections?.payment?.content }}</p>
              </div>
            }
            @for (section of s.customSections?.additional; track $index) {
              @if (section.isPublic) {
                <div class="description-block">
                  <h3>{{ section.title }}</h3>
                  <p class="formatted-text">{{ section.content }}</p>
                </div>
              }
            }
          </div>
        </section>

        <hr class="section-divider">
        <section class="reviews-section">
          <app-service-reviews [serviceId]="s.id"></app-service-reviews>
        </section>
      </div>
    }

    @if (viewMode() === 'calendar') {
      <div class="calendar-layout">
        <div class="calendar-header-block">
          <h3>Check Availability</h3>
          <p>Select a date and time to book {{ s.businessName }}</p>
        </div>
        <seeker-calendar [service]="s" [user]="user!" (bookRequest)="handleBookingSubmission($event)"></seeker-calendar>
      </div>
    }
  </main>
</div>
}

<!-- @if (service$ | async; as service) {
<div class="service-details-container">
  <button mat-button class="back-to-search-link" (click)="goBackToSearch()">
    <mat-icon>arrow_back</mat-icon>
    Back to Search Results
  </button>

  <mat-card class="combined-booking-card">
    <div class="card-content-wrapper">
      
      <div class="service-info-column">
        <div class="header-section">
          <img class="business-avatar" [src]="service.profilePicture?.url" alt="Profile">
          <div class="header-text">
            <h1 class="business-name">{{ service.businessName }}</h1>
            <div class="badge-row">
              <span class="category-tag">{{ service.category }}</span>
              @if (averageRating$ | async; as avg) {
                <div class="mini-rating">
                  <mat-icon>star</mat-icon>
                  <strong>{{ avg | number:'1.1-1' }}</strong>
                  <span class="total-count">({{ reviewCount$ | async }})</span>
                </div>
              }
            </div>

            <div class="content-block contact-section">
              <div class="contact-row">
                <mat-icon>place</mat-icon>
                <span>{{ service.businessAddress ?? "California, United States" }}</span>
              </div>
              <div class="contact-row">
                <mat-icon>call</mat-icon>
                <span>{{ service.phoneNumber ?? "Request for details"}}</span>
              </div>
            </div>
          </div>
        </div>

        <mat-card class="about-service-card">
          <div class="content-block">
            <h3>About the Service</h3>
            <p class="description">{{ service.description }}</p>
          </div>
        </mat-card>

        @if (service.portfolio && service.portfolio.length > 0) {
        <div class="content-block">
          <h3>Work Gallery</h3>
          <div class="portfolio-carousel">
            <div class="main-image-container">
              <img [src]="activeImageUrl" class="main-slide" alt="Portfolio work">
              
              @if (service.portfolio.length > 1) {
                <button class="nav-btn prev" (click)="prevSlide(service.portfolio)">
                  <mat-icon>chevron_left</mat-icon>
                </button>
                <button class="nav-btn next" (click)="nextSlide(service.portfolio)">
                  <mat-icon>chevron_right</mat-icon>
                </button>
              }
            </div>

            <div class="thumbnail-row">
              @for (img of service.portfolio; track img.public_id; let i = $index) {
                <div class="thumb-item" 
                      [class.active]="activeImageUrl === img.url!"
                      (click)="setActiveImage(img.url!, i)">
                  <img [src]="img.url.replace('/upload/', '/upload/w_100,h_100,c_fill,q_auto/')">
                </div>
              }
            </div>
          </div>
        </div>
        }

        <div class="content-block price-highlight">
          <div class="price-pill">
            <mat-icon>payments</mat-icon>
            <div class="price-details">
              <span class="label">Base Hourly Rate</span>
              <span class="amount">{{ service.hourlyRate | currency }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="calendar-booking-column">
        <div class="booking-header">
          <h2>Select Availability & Book</h2>
          <p>Choose a date to see available time slots</p>
        </div>
        <div class="calendar-card">
          <seeker-calendar
            [service]="service"
            [user]="user!"
            (bookRequest)="handleBookingSubmission($event)">
          </seeker-calendar>
        </div>
      </div>

    </div>
  </mat-card>

  <app-service-reviews [serviceId]="service.id"></app-service-reviews>
</div>
}

@if (showAuthOptions()) {
  <div class="modal-overlay">
    <div class="choice-card">
      <button class="close-btn" (click)="showAuthOptions.set(false)">
        <mat-icon>close</mat-icon>
      </button>

      <h2>Complete Your Request</h2>
      <p>Sign in to message the provider directly and track your booking in real-time.</p>

      <div class="actions">
       <div id="google-btn-container"></div>

        <button mat-stroked-button (click)="redirectToRegister()">
          Create Account / Sign In
        </button>

        <div class="divider">
          <span>OR</span>
        </div>

        <div class="guest-section">
          <p class="guest-label">Continue as guest (email only)</p>
          <div class="guest-input-group">
            <input type="email" #guestEmail placeholder="Enter your email" />
            <button mat-flat-button color="accent" 
                    [disabled]="isSubmitting()"
                    (click)="submitAsGuest(guestEmail.value)">
              {{ isSubmitting() ? 'Sending...' : 'Send Request' }}
            </button>
          </div>
          <small>Note: You won't be able to use the live chat as a guest.</small>
        </div>
      </div>
    </div>
  </div>
} -->