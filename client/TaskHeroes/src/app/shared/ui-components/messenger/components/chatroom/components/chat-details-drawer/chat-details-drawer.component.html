@if (isOpen()) {
    <div class="details-drawer-overlay" [class.active]="isOpen()">
        <header class="drawer-header">
            <h3>Job Info</h3>
            <button class="close-btn" (click)="close.emit()">
                <i class="material-icons">close</i>
            </button>
        </header>

        <div class="drawer-body">
            @if (state()?.isProvider && jobDetails(); as job) {
                <section class="service-summary-card seeker-card clickable" (click)="openSeekerPortfolio()">
                    <div class="service-icon seeker-avatar">
                        <i class="material-icons">person_search</i>
                    </div>
                    <div class="service-info">
                        <h4>Seeker Portfolio</h4>
                        <span class="category-tag">Verified User</span>
                        @if (partnerReputation(); as rep) {
                            <div class="rating-mini">
                                <i class="material-icons">star</i>
                                <span>{{ rep.averageRating || 'No' }} ({{ rep.totalItems }} reviews)</span>
                            </div>
                        } 
                    </div>
                </section>
            }
            @if (serviceDetails(); as service) {
                <section class="service-summary-card clickable" (click)="openServiceExternal()">
                    <div class="service-icon">
                        <i class="material-icons">{{ 'stars' }}</i>
                    </div>
                    <div class="service-info">
                        <h4>{{ service.businessName }}</h4>
                        <span class="category-tag">{{ service.category }}</span>
                    </div>
                </section>
            }

            @if (jobDetails(); as details) {
                <div class="logistics-container">

                    <section class="detail-group appointment-section"
                             (mouseenter)="openMenu()" 
                             (mouseleave)="closeMenu()">
                        <div class="appointment-row clickable-area">
                            <div class="main-info">
                                <span class="date">{{ details.jobDate | date:'EEE, MMM d' }}</span>
                                <span class="divider">at</span>
                                <span class="time">{{ details.startTime }}</span>
                                <span class="duration-badge">{{ (details.duration || 0) / 60 }} hrs</span>
                            </div>
                        </div>  
                        <section class="detail-group">
                            <p>{{ details.location || 'TBD'}}</p>
                        </section>
                            
                        @if (showCalendarMenu()) {
                            <div class="calendar-options-menu">
                                <a [href]="generateCalendarLink()" target="_blank" (click)="$event.stopPropagation(); showCalendarMenu.set(false)">
                                   <i class="material-icons">event</i> Add to Google Calendar
                                </a>
                                <a [href]="generateICalLink()" [download]="'taskheroes-job.ics'" (click)="$event.stopPropagation(); showCalendarMenu.set(false)">
                                   <i class="material-icons">download</i> Download Apple Calendar
                                </a>
                            </div>
                        }
                    </section>
                </div>

                <section class="detail-group price-section">
                    <label>Fee Quoted</label>
            
                    @if (!isEditingPrice()) {
                        <div class="fee-display">
                            @for (item of details.priceBreakdown; track $index) {
                                <div class="price-row">
                                    <span class="item-label">{{ item.label }}</span>
                                    <span class="item-amount">{{ item.amount | currency }}</span>
                                </div>
                            }
                            <div class="total-row">
                                <strong>Total Quote</strong>
                                <strong>{{ readonlyTotal() | currency }}</strong>
                            </div>
                            
                            @if (state()?.canRequestChange) {
                                <button class="btn-adjust" (click)="startEdit()">
                                    <i class="material-icons">payments</i> Adjust Quote
                                </button>
                            }
                        </div>

                        <section class="drawer-action-hub">
                            @if (state(); as ui) {
                                @if (ui.canAcceptInquiry) {
                                    <div class="action-card inquiry-phase">
                                        <p>Accept this inquiry to move to the confirmation phase.</p>
                                        <div class="btn-group-vertical">
                                            <button class="btn-primary" (click)="updateJobStatus(JobStatus.Accepted)">Accept Inquiry</button>
                                            <button class="btn-outline" (click)="updateJobStatus(JobStatus.CancelledByProvider)">Decline</button>
                                        </div>
                                    </div>
                                }

                                @if (ui.needsMyConfirmation) {
                                    <div class="action-card confirmation-phase">
                                        <h4>Confirm Booking</h4>
                                        <p>By confirming, you acknowledge that all offline payment terms (e.g. 20% deposit) have been settled.</p>
                                        <button class="btn-confirm-booking" (click)="updateJobStatus(JobStatus.Booked)">
                                            Confirm My Side
                                        </button>
                                    </div>
                                }

                                @if (ui.isWaitingForPartner) {
                                    <div class="waiting-badge">
                                        <i class="material-icons rotating">sync</i>
                                        <span>Awaiting partner's confirmation...</span>
                                    </div>
                                }

                                @if (ui.isFullyBooked) {
                                    <div class="booked-badge">
                                        <i class="material-icons">check_circle</i>
                                        <span>This job is officially Booked!</span>
                                    </div>
                                }
                            }
                        </section>
                    } @else {
                        <div class="edit-quote-container">
                            <div class="items-list-editor">
                                @for (item of lineItems(); track $index) {
                                   <div class="quote-row" [class.is-base]="item.type === 'base'">
                                        <div class="item-info">
                                            @if (item.type === 'base') {
                                                <span class="base-label">Service Fee</span>
                                                <div class="base-calculation">
                                                    <input type="number" 
                                                           [ngModel]="duration()/60" 
                                                           (ngModelChange)="duration.set($event * 60); updateBaseItem()" 
                                                           class="mini-input">
                                                    <span class="unit">hrs</span>
                                                    <span class="op">&#64;</span>
                                                    <span class="unit">$</span>
                                                    <input type="number" 
                                                           [ngModel]="hourlyRate()" 
                                                           (ngModelChange)="hourlyRate.set($event); updateBaseItem()" 
                                                           class="mini-input">
                                                    <span class="unit">/hr</span>
                                                </div>
                                            } @else {
                                                <input [(ngModel)]="item.label" placeholder="Item name" class="item-input">
                                            }
                                        </div>
                                        
                                        <div class="price-input-wrapper">
                                            <span>$</span>
                                            <input type="number" 
                                                   [(ngModel)]="item.amount" 
                                                   [readonly]="item.type === 'base'" 
                                                   class="amount-input">
                                        </div>

                                        @if (item.type !== 'base') {
                                            <button (click)="removeItem($index)" class="btn-remove">
                                                <i class="material-icons">delete_outline</i>
                                            </button>
                                        }
                                    </div>
                                }
                                <button class="btn-add-line" (click)="addItem()">
                                    <i class="material-icons">add</i> Add Extra Fee
                                </button>
                            </div>

                            <div class="final-summary">
                                <label>New Total Quote:</label>
                                <span class="total-amount">{{ calculatedTotal() | currency }}</span>
                            </div>

                            <div class="action-buttons">
                                <button class="btn-cancel" (click)="cancelEdit()">Cancel</button>
                                <button class="btn-save" 
                                        [disabled]="isSubmitting() || calculatedTotal() <= 0" 
                                        (click)="submitAdjustment()">
                                    Send Request
                                </button>
                            </div>
                        </div>
                    }               
                </section>

                <section class="detail-group agreement-section">
                    <div class="section-header">
                        <label>Job Terms</label>
                        @if (state()?.canRequestChange && !isEditingAgreement()) {
                            <button class="btn-text-action" (click)="isEditingAgreement.set(true)">
                                <i class="material-icons">edit</i> Edit
                            </button>
                        }
                    </div>

                    @if (!isEditingAgreement()) {
                        <div class="agreement-display">
                            <p class="terms-text" [innerHTML]="jobDetails()?.providerTerms || 'No specific terms provided.'"></p>
                            
                            @if (jobDetails()?.documents?.length) {
                                <div class="links-list">
                                    @for (doc of jobDetails()?.documents; track doc.url) {
                                        <a [href]="doc.url" target="_blank" rel="noopener noreferrer" class="external-link">
                                            <i class="material-icons">link</i> {{ doc.name }}
                                        </a>
                                    }
                                </div>
                            }
                        </div>
                    } @else {
                        <div class="agreement-editor">

                            <div class="quill-wrapper">
                                <div id="quill-editor" style="height: 150px;"></div>
                            </div>
                            
                            <div class="link-builder">
                                <div class="link-inputs">
                                    <input [(ngModel)]="tempLinkName" placeholder="Link Label (e.g. Contract)">
                                    <input [(ngModel)]="tempLinkUrl" placeholder="URL (Google Drive/Dropbox)">
                                    <button class="btn-add-link" (click)="addLink()" [disabled]="!tempLinkUrl">
                                        <i class="material-icons">add</i>
                                    </button>
                                </div>

                                <div class="pending-links">
                                    @for (link of localLinks(); track $index) {
                                        <div class="link-tag">
                                            <span>{{ link.name }}</span>
                                            <i class="material-icons" (click)="removeLink($index)">close</i>
                                        </div>
                                    }
                                </div>
                            </div>

                            <div class="editor-actions">
                                <button class="btn-cancel-small" (click)="isEditingAgreement.set(false)">Cancel</button>
                                <button class="btn-save-small" (click)="saveAgreementWithQuill()">Update Agreement</button>
                            </div>
                        </div>
                    }
                </section>
            }
        </div>
    </div>
}